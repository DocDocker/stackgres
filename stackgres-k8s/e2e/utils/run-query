#!/bin/sh

run_query() {
  local NAME="${CLUSTER_NAME:-stackgres}"
  local INSTANCE=0
  local NAMESPACE="${CLUSTER_NAMESPACE:-stackgres}"
  local QUERY="'SELECT 1'"
  local PORT=5432
  local HOST=127.0.0.1
  local DATABASE=postgres

  while getopts ":c:n:i:q:p:h:d:" opt; do
    case $opt in
      c) NAME="$OPTARG"
      ;;
      n) NAMESPACE="$OPTARG"
      ;;
      i) INSTANCE="$OPTARG"
      ;;
      q) QUERY="$OPTARG"
      ;;
      p) PORT="$OPTARG"
      ;;
      h) HOST="$OPTARG"
      ;;
      d) DATABASE="$OPTARG"
      ;;
      \?) echo "Invalid option -$OPTARG" >&2
      return 1
      ;;
    esac
  done

  kubectl exec -t -n "$NAMESPACE" "$NAME-$INSTANCE" -c postgres-util -- sh -c "PGPASSWORD=$(kubectl -n "$NAMESPACE" get secrets "$NAME" -o jsonpath='{.data.superuser-password}' | base64 -d) PGCONNECT_TIMEOUT=5 psql -t -A -U postgres -d $DATABASE -p $PORT -c $QUERY -h $HOST"
}