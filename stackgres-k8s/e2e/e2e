#!/bin/sh

set -e

export SHELL="$(readlink /proc/$$/exe)"
if [ "$(basename "$SHELL")" = busybox ]
then
  SHELL=sh
fi
SHELL_XTRACE="$(! echo $- | grep -q x || echo "-x")"

export TARGET_PATH="${TARGET_PATH:-$(dirname "$0")/target}"
export TARGET_PATH="$(realpath "$TARGET_PATH")"
export LOG_PATH="$TARGET_PATH"

[ -z "$SHELL_XTRACE" ] || set +x

if ! command -v local > /dev/null 2>&1
then
  >&2 echo "You are probably using an AT&T Korn Shell or any other shell that does not support local variables in POSIX functions."
  exit 1
fi

E2E_SOURCES="0"

e2e_add_source() {
  eval "E2E_SOURCES_$E2E_SOURCES=$1"
  E2E_SOURCES="$((E2E_SOURCES + 1))"
}

for util in $(find "$(dirname "$0")/utils" -type f)
do
  . "$util"
done

while [ "$E2E_SOURCES" -gt 0 ]
do
  E2E_SOURCES="$((E2E_SOURCES - 1))"
  eval ". \"$(dirname "$0")/\$E2E_SOURCES_$E2E_SOURCES\""
done

[ -z "$SHELL_XTRACE" ] || set -x

if [ "$(basename "$0")" = "e2e" -a ! -z "$1" ]
then
  "$@"
fi
