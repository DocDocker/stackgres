#!/bin/sh

set -e

IMAGE_TAG="${IMAGE_TAG:-development-jvm}"
IMAGE_NAME="stackgres/operator:$IMAGE_TAG"
KUBERNETES_VERSION="${KUBERNETES_VERSION:-1.12.10}"
ENV="${ENV:-kind}"
TARGET_PATH="$(dirname "$0")/target"
BUILD_OPERATOR="${BUILD_OPERATOR:-true}"
WAIT_OPERATOR="${WAIT_OPERATOR:-true}"
RESET_NAMESPACES="${RESET_NAMESPACE:-true}"
TIMEOUT="${TIMEOUT:-180}"
TRAP_ENABLED="${TRAP_ENABLED:-false}"
SKIP_K8S_SETUP="${SKIP_K8S_SETUP:-false}"

if [ -z "$STACKGRES_PATH" ]
then
  STACKGRES_PATH="$(dirname "$0")/.."
fi
OPERATOR_CHART_PATH="${OPERATOR_CHART_PATH:-"$STACKGRES_PATH/install/helm/stackgres-operator/"}"
CLUSTER_CHART_PATH="${CLUSTER_CHART_PATH:-"$STACKGRES_PATH/install/helm/stackgres-cluster/"}"

export IMAGE_TAG IMAGE_NAME KUBERNETES_VERSION CLUSTER_CHART_PATH ENV TARGET_PATH TIMEOUT

for util in $(find "$(dirname "$0")/utils" -type f)
do
  . "$util"
done

trap_kill() {
  echo "$1" >> "$TARGET_PATH/trap-kill"
}

trap_callback() {
  if [ -s "$TARGET_PATH/trap-kill" ]
  then
    sleep 1 # Let the tails write to output remaining logs.
    kill $(cat "$TARGET_PATH/trap-kill") || true
  fi
}

setup_k8s() {
  if ! $TRAP_ENABLED
  then
    rm -rf "$TARGET_PATH"
    mkdir -p "$TARGET_PATH/logs"
    trap 'trap_callback' EXIT
    trap 'exit $?' HUP INT QUIT PIPE TERM
    export TRAP_ENABLED=true
  fi

  if [ "$SKIP_K8S_SETUP" = true ]
  then
    return
  fi

  . "$(dirname "$0")/envs/$ENV"

  if [ "$REUSE_K8S" != true ]
  then
    reset_k8s
  else
    reuse_k8s
  fi

  setup_tiller

  helm dependency update "$OPERATOR_CHART_PATH"
  helm dependency update "$CLUSTER_CHART_PATH"

  if [ "$BUILD_OPERATOR" = true ] \
    && (
      ! helm list | grep -q "^stackgres-operator\s" \
      || [ "$REUSE_OPERATOR" != true ]
    )
  then
    mvn -f "$STACKGRES_PATH/src/pom.xml" -q clean package -P build-image-jvm
  fi

  if ! helm list | grep -q "^stackgres-operator\s" \
    || ! kubectl get namespaces stackgres -o name \
      | grep -q "^namespace/stackgres$" \
    || (! kubectl get deployments.apps -n stackgres -o name \
      | grep -q "^deployment.apps/stackgres-operator$" \
      && [ "$USE_EXTERNAL_OPERATOR" != true ])\
    || [ "$REUSE_OPERATOR" != true ]
  then
    load_operator_k8s

    helm list -a \
      | tail -n +2 \
      | sed 's/\s\+/ /g' \
      | cut -d ' ' -f 1 \
      | grep -v "^\(minio\)$" \
      | xargs -r -n 1 -I % helm delete --purge %
    helm template --name stackgres-operator --namespace stackgres "$OPERATOR_CHART_PATH" \
      | kubectl delete -f - --ignore-not-found
    kubectl get validatingwebhookconfigurations.admissionregistration.k8s.io -o name \
      | xargs -r -n 1 -I % kubectl delete %
    if [ "$RESET_NAMESPACES" = true ]
    then
      kubectl get namespace -o name \
        | grep -v "^namespace/\(default\|kube-system\|kube-public\|minio\)$" \
        | xargs -r -n 1 -I % -P 0 sh -ec '
        kubectl delete namespace % &
        sleep 3
        kubectl delete pod -n % --all --force --grace-period 0
        wait'
    fi
    helm install --name stackgres-operator --namespace stackgres "$OPERATOR_CHART_PATH" \
      --set-string image.tag="$IMAGE_TAG" --set-string image.pullPolicy=Never
    if [ "$DEBUG_OPERATOR" = true ]
    then
      wait_pods_running stackgres
      kubectl set env -n stackgres deployment/stackgres-operator \
        DEBUG_OPERATOR="$DEBUG_OPERATOR" DEBUG_OPERATOR_SUSPEND="$DEBUG_OPERATOR_SUSPEND"
      kubectl delete pod -n stackgres "$(kubectl get pod -n stackgres -o name|cut -d / -f 2|tail -n 1)"
    fi
  else
    helm list -a \
      | tail -n +2 \
      | sed 's/\s\+/ /g' \
      | cut -d ' ' -f 1 \
      | grep -v "^\(stackgres-operator\|minio\)$" \
      | xargs -r -n 1 -I % helm delete --purge %
    if [ "$RESET_NAMESPACES" = true ]
    then
      kubectl get namespace -o name \
        | grep -v "^namespace/\(default\|kube-system\|kube-public\|minio\|stackgres\)$" | cut -d / -f 2 \
        | xargs -r -n 1 -I % -P 0 sh -ec '
        kubectl delete namespace % &
        sleep 3
        kubectl delete pod -n % --all --force --grace-period 0
        wait'
    fi
  fi

  if [ "$WAIT_OPERATOR" = true ]
  then
    wait_pods_running stackgres
  fi
  wait_pods_running
}

if [ "$(basename "$0")" = "e2e" -a ! -z "$1" ]
then
  "$@"
fi
