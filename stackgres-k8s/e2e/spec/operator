#!/bin/sh

e2e_exclusive_lock() {
  true
}

e2e_test_install() {
  k8s_cleanup_namespace "$OPERATOR_NAMESPACE"
  k8s_async_cleanup
}

e2e_test_uninstall() {
  delete_operator
  install_operator
  wait_pods_running "$OPERATOR_NAMESPACE" 2
}

e2e_test() {
  run_test "Check that operator can be installed" check_operator_install
  run_test "Check that operator can be upgrade with same values" check_operator_upgrade
  run_test "Check that operator can be deleted" check_operator_delete
  run_test "Check that operator can be installed from outside" check_operator_install_outside
  run_test "Check that operator can be installed with load balancer" check_operator_install_load_balancer
  run_test "Check that operator can be installed with the '--wait' option" check_operator_install_with_wait
}

check_operator_install() {
  install_operator

  for app in operator restapi; do
    if kubectl rollout status -n "$OPERATOR_NAMESPACE" "deployment/stackgres-${app}"; then
      echo "SUCCESS. Deployment 'stackgres-${app}' was rolled out."
      continue
    fi

    echo "FAILED. Deployment 'stackgres-${app}' was not rolled out."
    return 1
  done
}

check_operator_upgrade() {
  upgrade_operator

  for app in operator restapi; do
    if kubectl rollout status -n "$OPERATOR_NAMESPACE" "deployment/stackgres-${app}"; then
      echo "SUCCESS. Deployment 'stackgres-${app}' was rolled out."
      continue
    fi

    echo "FAILED. Deployment 'stackgres-${app}' was not rolled out."
    return 1
  done
}

check_operator_delete() {
  delete_operator
}

check_operator_install_outside() {
  delete_operator

  install_operator --set-string service.type=NodePort --set service.nodePort=31111

  for app in operator restapi; do
    if kubectl rollout status -n "$OPERATOR_NAMESPACE" "deployment/stackgres-${app}"; then
      echo "SUCCESS. Deployment 'stackgres-${app}' was rolled out."
      continue
    fi

    echo "FAILED. Deployment 'stackgres-${app}' was not rolled out."
    return 1
  done
}

check_operator_install_load_balancer() {
  delete_operator

  install_operator --set service.loadBalancer.enabled=true

  for app in operator restapi; do
    if kubectl rollout status -n "$OPERATOR_NAMESPACE" "deployment/stackgres-${app}"; then
      echo "SUCCESS. Deployment 'stackgres-${app}' was rolled out."
      continue
    fi

    echo "FAILED. Deployment 'stackgres-${app}' was not rolled out."
    return 1
  done
}

check_operator_install_with_wait() {
  delete_operator

  install_operator \
    --wait

  for app in operator restapi; do
    if kubectl rollout status -n "$OPERATOR_NAMESPACE" "deployment/stackgres-${app}"; then
      echo "SUCCESS. Deployment 'stackgres-${app}' was rolled out after using --wait parameter."
      continue
    fi

    echo "FAILED. Deployment 'stackgres-${app}' was not rolled out after using --wait parameter."
    return 1
  done
}