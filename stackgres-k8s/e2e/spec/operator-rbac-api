#!/bin/sh

e2e_test_install() {
  kubectl create namespace "$CLUSTER_NAMESPACE"
  deploy_curl_pod "$CLUSTER_NAMESPACE"

  wait_pods_running "$CLUSTER_NAMESPACE" 1
}

e2e_test() {
  run_test "RBAC can-i endpoint should success" check_rbac_success

  run_test "RBAC can-i endpoint should fail" check_rbac_failure
}

get_rbac_status() {
  run_curl -r "stackgres/auth/rbac/can-i/$1/sgclusters?namespace=$CLUSTER_NAMESPACE" -n $CLUSTER_NAMESPACE -e "-LI -o /dev/null -w %{http_code}"
}

check_rbac_success() {
  local HTTP_STATUS

  HTTP_STATUS="$(get_rbac_status "get")"

  if [ "$HTTP_STATUS" = "200" ]
  then
    echo "Success. rbac can-i endpoint is available"
  else
    echo "Fail. rbac can-i endpoint is not available"
    return 1
  fi
}

check_rbac_failure() {
  kubectl delete clusterrolebinding stackgres-restapi-admin
  kubectl create clusterrolebinding stackgres-restapi-admin --clusterrole=view --user=admin
  local HTTP_STATUS

  HTTP_STATUS="$(get_rbac_status "create")"

  kubectl delete clusterrolebinding stackgres-restapi-admin
  kubectl create clusterrolebinding stackgres-restapi-admin --clusterrole=cluster-admin --user=admin

  if [ "$HTTP_STATUS" = "403" ]
  then
    echo "Success. rbac can-i endpoint is available"
  else
    echo "Fail. rbac can-i endpoint is not available"
    return 1
  fi
}
