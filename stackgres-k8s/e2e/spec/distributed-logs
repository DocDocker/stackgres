#!/bin/sh

e2e_test_install() {
  DISTRIBUTED_LOGS_NAME=distributedlogs

  create_or_replace_cluster "$CLUSTER_NAME" "$CLUSTER_NAMESPACE" "1" \
    --set cluster.distributedLogs.enabled=true \
    --set-string cluster.distributedLogs.name="$DISTRIBUTED_LOGS_NAME" \
    --set-string cluster.distributedLogs.volumeSize=128Mi

  deploy_psql_pod "$CLUSTER_NAMESPACE"

  wait_pods_running "$CLUSTER_NAMESPACE" "3"
}

e2e_test() {
  run_test "Checking that is possible to connect using services is working" service_check
}

service_check() {
  RESPONSE_PRIMARY="$(run_query -c "$DISTRIBUTED_LOGS_NAME" -x psql -k postgres \
    -h "$DISTRIBUTED_LOGS_NAME"-primary -i 0 -p 5432)"

  if [ "$RESPONSE_PRIMARY" = "1" ]
  then
    echo "SUCCESS: Connections are possible using services"
    return 0
  else
    echo "FAIL: Cannot connect to primary db using a kubernetes service"
    return 1
  fi
}
